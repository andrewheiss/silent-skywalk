---
title: Hypotheses
format:
  html:
    code-fold: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center", fig.retina = 3,
  fig.width = 6, fig.height = (6 * 0.618),
  out.width = "80%", collapse = TRUE,
  dev = "ragg_png"
)

options(
  digits = 3, width = 120,
  dplyr.summarise.inform = FALSE,
  knitr.kable.NA = ""
)
```

```{r libraries-functions, warning=FALSE, message=FALSE}
library(tidyverse)
library(scales)
library(glue)
library(here)
library(patchwork)
library(tidybayes)
library(gt)
library(gtExtras)
library(rcartocolor)
library(Matrix)

label_pp <- label_number(accuracy = 1, scale = 100, 
  suffix = " pp.", style_negative = "minus")

fmt_decimal <- label_number(accuracy = 0.001, style_negative = "minus")

build_ci <- function(lower, upper) {
  glue("[{fmt_decimal(lower)}, {fmt_decimal(upper)}]")
}

theme_nice <- function() {
  theme_minimal(base_family = "Clear Sans") +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(family = "Clear Sans", face = "bold"),
      axis.title.x = element_text(hjust = 0),
      axis.title.y = element_text(hjust = 1),
      strip.text = element_text(family = "Clear Sans", face = "bold",
        size = rel(0.75), hjust = 0),
      strip.background = element_rect(fill = "grey90", color = NA))
}

opts_theme <- function(x) {
  x %>% 
    opt_table_font(font = "Inter") %>% 
    tab_options(column_labels.font.weight = "bold",
                row_group.font.weight = "bold")
}

theme_set(theme_nice())
prism <- carto_pal(name = "Prism")
peach <- carto_pal(name = "Peach")
```

```{r create-ref-grid}
all_combos <- expand_grid(
  feat_org = c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross"), 
  feat_issue = c("Emergency response", "Environment", "Human rights", "Refugee relief"),
  feat_transp = c("No", "Yes"), 
  feat_acc = c("No", "Yes"),
  feat_funding = c("Many small donors", "Handful of wealthy private donors", "Government grants"),
  feat_govt = c("Friendly", "Criticized", "Under crackdown")
) %>% 
  mutate(across(everything(), ~fct_inorder(.)))

all_combos_design_grid <- sparse.model.matrix(
  ~ 0 + feat_org + feat_issue + feat_transp + 
    feat_acc + feat_funding + feat_govt, 
  data = all_combos
)
```

```{r create-all-combos-means}
gammas_raw <- readRDS(here("data", "raw_data", "posterior_draws", "intercept.rds"))

all_combos_means <- gammas_raw %>% 
  pivot_wider(names_from = i, values_from = Gamma) %>% 
  group_by(j, .chain, .iteration, .draw) %>% 
  nest() %>% 
  mutate(pi = map(data, ~{
    preds <- as.numeric(all_combos_design_grid %*% as.numeric(.))
    all_combos %>% 
      mutate(
        .linpred = preds, 
        # fake bc it's not actually mean(posterior_predict(.))
        .epred = plogis(preds)
      )
  })) %>% 
  select(-data) %>% 
  unnest(pi)
```




# H~1~: Branding

::: {.callout-tip}
## H~1~: Branding

**Donors will be more likely to donate to Oxfam and Red Cross compared to Amnesty International and Greenpeace.**

*Mechanism: awareness of need and contentiousness of issue area*
:::

### Estimand

$$
\begin{aligned}
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Organization} = \text{Oxfam or Red Cross} \right) \bigr] - \\
&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Organization} = \text{Amnesty International or Greenpeace} \right) \bigr]
\end{aligned}
$$

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Donors are indeed more likely to donate to Red Cross compared to Amnesty International and Greenpeace. However, compared to Amnesty International and Greenpeace, donors are less likely to donate to Oxfam. In fact, there is a negligible difference between donors likelihood to donate to Oxfam and Amnesty International.

![](img/contrasts_hypothesis01.png)
:::

```{r h1-calc-estimands}
h1_mms <- all_combos_means %>% 
  group_by(feat_org, .draw) %>% 
  summarize(avg = mean(.epred))

h1_amces <- h1_mms %>% 
  group_by(feat_org) %>% 
  compare_levels(variable = avg, by = feat_org, comparison = "control")
```

```{r plot-h1-mm-amce, fig.width=10, fig.height=4, out.width="100%"}
#| column: body-outset
p_h1_mms <- h1_mms %>% 
  ggplot(aes(x = avg, y = feat_org, fill = feat_org)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(1, 3, 5, 7)], guide = "none") +
  labs(
    x = "Overall average predicted probability",
    y = NULL,
    fill = NULL,
    title = "Estimated marginal means"
  )

p_h1_amces <- h1_amces %>% 
  ungroup() %>% 
    separate_wider_delim(
    feat_org,
    delim = " - ", 
    names = c("feat_org", "reference_level")
  ) %>% 
  add_row(avg = 0, feat_org = "Amnesty International") %>% 
  ggplot(aes(x = avg, y = feat_org, fill = feat_org)) +
  stat_halfeye() +
  geom_vline(xintercept = 0, color = prism[8], linetype = "dashed", linewidth = 0.25) +
  scale_x_continuous(labels = label_pp) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(1, 3, 5, 7)], guide = "none") +
  labs(
    x = "Percentage point change in probability of choice selection",
    y = NULL,
    fill = NULL,
    title = "Average marginal component effects (AMCEs)"
  )

p_h1_mms | p_h1_amces
```

```{r table-h1-mm-amce}
#| column: body-outset
h1_tbl_mm <- h1_mms %>% 
  group_by(feat_org) %>% 
  median_qi() %>% 
  mutate(nice = glue("{fmt_decimal(avg)}<br>{build_ci(.lower, .upper)}")) %>% 
  arrange(desc(feat_org)) %>% 
  select(feat_org, nice)

h1_tbl_amces <- h1_amces %>% 
  group_by(feat_org) %>% 
  summarize(
    median_qi(avg),
    p_gt_0 = sum(avg > 0) / n()
  ) %>%
  mutate(p_neq_0 = ifelse(y >= 0, p_gt_0, 1 - p_gt_0)) %>% 
  mutate(nice = glue("{fmt_decimal(y)}<br>{build_ci(ymin, ymax)}")) %>% 
  mutate(feat_org = str_replace(feat_org, " - ", "−<br>")) %>% 
  mutate(across(starts_with("p_"), ~fmt_decimal(.))) %>% 
  arrange(desc(feat_org)) %>% 
  select(contrast = feat_org, amce_nice = nice, p_neq_0)

bind_cols(
  h1_tbl_mm, 
  add_row(h1_tbl_amces, contrast = "*(Reference)*")
) %>% 
  gt() %>% 
  sub_missing(columns = everything(), missing_text = "—") %>% 
  fmt_markdown(columns = c(nice, amce_nice, contrast)) %>%
  cols_align(align = "center", columns = everything()) %>% 
  cols_align(align = "left", columns = c(feat_org, contrast)) %>% 
  cols_label(
    feat_org = "Organization", 
    nice = "Posterior EMM",
    contrast = "Contrast",
    amce_nice = "Posterior AMCE",
    p_neq_0 = "*p*~direction~",
    .fn = md
  ) %>% 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>% 
  tab_footnote(
    footnote = "Values are on the percentage-point scale; single value is posterior median; 95% credible interval in brackets.",
    locations = cells_column_labels(columns = c(nice, amce_nice))
  ) %>% 
  tab_footnote(
    footnote = md("The probability of direction (*p*~direction~) is the probability that the posterior AMCE is strictly positive or negative—it is the proportion of the posterior AMCE that is the sign of the median."),
    locations = cells_column_labels(columns = p_neq_0)
  ) %>% 
  gt_add_divider(columns = nice, style = "dashed", weight = px(1)) %>% 
  opt_footnote_marks(marks = "standard") %>% 
  opt_horizontal_padding(3) %>% 
  opts_theme()
```


# H~2~: Government crackdown

## H~2a~: Relationship with host government

::: {.callout-tip}
## H~2a~: Relationship with host government

**Donors will show increased willingness to donate to NGOs that are facing government crackdown or criticism.**

*Mechanism: Governments wouldn't be cracking down on them if they didn't perceive a threat from them which means organizations implementing their missions effectively. This perception of efficacy leads to increased donations.*
:::

### Estimand

$$
\begin{aligned}
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Relationship} = \text{Under crackdown} \right) \bigr] - 
\textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Relationship} = \text{Friendly} \right) \bigr] \\[10pt]
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Relationship} = \text{Criticized} \right) \bigr] - \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Relationship} = \text{Friendly} \right) \bigr]
\end{aligned}
$$

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Contrary to our hypothesis, donors showed decreased willingness to donate to NGOs that are facing government crackdown or criticism. This decreased likelihood to donate is also greater for NGOs under crackdown compared to those under criticism.

![](img/contrasts_hypothesis02a.png)
:::

```{r h2a-calc-estimands}
h2a_mms <- all_combos_means %>% 
  group_by(feat_govt, .draw) %>% 
  summarize(avg = mean(.epred))

h2a_amces <- h2a_mms %>% 
  group_by(feat_govt) %>% 
  compare_levels(variable = avg, by = feat_govt, comparison = "control")
```

```{r plot-h2a-mm-amce, fig.width=10, fig.height=4, out.width="100%"}
#| column: body-outset
p_h2a_mms <- h2a_mms %>% 
  ggplot(aes(x = avg, y = feat_govt, fill = feat_govt)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = peach[c(2, 5, 7)], guide = "none") +
  labs(
    x = "Overall average predicted probability",
    y = NULL,
    fill = NULL,
    title = "Estimated marginal means"
  )

p_h2a_amces <- h2a_amces %>% 
  ungroup() %>% 
  separate_wider_delim(
    feat_govt,
    delim = " - ", 
    names = c("feat_govt", "reference_level")
  ) %>% 
  add_row(avg = 0, feat_govt = "Friendly") %>%
  mutate(feat_govt = factor(feat_govt, levels = levels(h2a_mms$feat_govt))) %>% 
  ggplot(aes(x = avg, y = feat_govt, fill = feat_govt)) +
  stat_halfeye() +
  geom_vline(xintercept = 0, color = prism[8], linetype = "dashed", linewidth = 0.25) +
  scale_x_continuous(labels = label_pp) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = peach[c(2, 5, 7)], guide = "none") +
  labs(
    x = "Percentage point change in probability of choice selection",
    y = NULL,
    fill = NULL,
    title = "Average marginal component effects (AMCEs)"
  )

p_h2a_mms | p_h2a_amces
```

```{r table-h2a-mm-amce}
#| column: body-outset
h2a_tbl_mm <- h2a_mms %>% 
  group_by(feat_govt) %>% 
  median_qi() %>% 
  mutate(nice = glue("{fmt_decimal(avg)}<br>{build_ci(.lower, .upper)}")) %>% 
  arrange(desc(feat_govt)) %>% 
  select(feat_govt, nice)

h2a_tbl_amces <- h2a_amces %>% 
  group_by(feat_govt) %>% 
  summarize(
    median_qi(avg),
    p_gt_0 = sum(avg > 0) / n()
  ) %>%
  mutate(p_neq_0 = ifelse(y >= 0, p_gt_0, 1 - p_gt_0)) %>% 
  mutate(nice = glue("{fmt_decimal(y)}<br>{build_ci(ymin, ymax)}")) %>% 
  mutate(feat_govt = str_replace(feat_govt, " - ", "−<br>")) %>% 
  mutate(across(starts_with("p_"), ~fmt_decimal(.))) %>% 
  arrange(desc(feat_govt)) %>% 
  select(contrast = feat_govt, amce_nice = nice, p_neq_0)

bind_cols(
  h2a_tbl_mm, 
  add_row(h2a_tbl_amces, contrast = "*(Reference)*")
) %>% 
  gt() %>% 
  sub_missing(columns = everything(), missing_text = "—") %>% 
  fmt_markdown(columns = c(nice, amce_nice, contrast)) %>%
  cols_align(align = "center", columns = everything()) %>% 
  cols_align(align = "left", columns = c(feat_govt, contrast)) %>% 
  cols_label(
    feat_govt = "Relationship", 
    nice = "Posterior EMM",
    contrast = "Contrast",
    amce_nice = "Posterior AMCE",
    p_neq_0 = "*p*~direction~",
    .fn = md
  ) %>% 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>% 
  tab_footnote(
    footnote = "Values are on the percentage-point scale; single value is posterior median; 95% credible interval in brackets.",
    locations = cells_column_labels(columns = c(nice, amce_nice))
  ) %>% 
  tab_footnote(
    footnote = md("The probability of direction (*p*~direction~) is the probability that the posterior AMCE is strictly positive or negative—it is the proportion of the posterior AMCE that is the sign of the median."),
    locations = cells_column_labels(columns = p_neq_0)
  ) %>% 
  gt_add_divider(columns = nice, style = "dashed", weight = px(1)) %>% 
  opt_footnote_marks(marks = "standard") %>% 
  opt_horizontal_padding(3) %>% 
  opts_theme()
```


## H~2b~: Organization and relationship with host government

::: {.callout-tip}
## H~2b~: Organization and relationship with host government

**Donors will show increased willingness to donate to Oxfam and Red Cross when they are facing government crackdown or criticism compared to when Amnesty or Greenpeace is facing crackdown.**
:::

### Estimand

$$
\begin{aligned}
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Organization} = \text{Oxfam or Red Cross}  \mid \text{Relationship = Under crackdown or Criticized} \right) \bigr] - \\
&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Organization} = \text{Amnesty International or Greenpeace} \mid \text{Relationship = Under crackdown or Criticized} \right) \bigr]
\end{aligned}
$$

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

These data don't support our hypothesis; the Red Cross brand has an insignificant impact on likelihood to donate compared to both Greenpeace and Amnesty. While the contrasts for Oxfam are closer to being statistically significant, the effect is working in the other direction--Greenpeace and Amnesty both induce increased likelihood to donate on behalf of donors.

![](img/contrasts_hypothesis02b.png)

![](img/contrasts_hypothesis02b_alt.png)
:::

```{r h2b-calc-estimands}
h2b_mms <- all_combos_means %>% 
  mutate(org_collapsed = fct_collapse(feat_org, 
    `Oxfam & Red Cross` = c("Oxfam", "Red Cross"),
    `Amnesty International & Greenpeace` = c("Amnesty International", "Greenpeace"))) %>% 
  group_by(org_collapsed, feat_govt, .draw) %>% 
  summarize(avg = mean(.epred))

h2b_amces <- h2b_mms %>% 
  group_by(feat_govt) %>% 
  compare_levels(variable = avg, by = org_collapsed, comparison = "control")
```

```{r plot-h2b-mm-amce, fig.width=6.5, fig.height=7, out.width="70%"}
#| column: body-outset
p_h2b_mms <- h2b_mms %>% 
  ggplot(aes(x = avg, y = feat_govt, fill = feat_govt)) +
  stat_halfeye(aes(slab_alpha = org_collapsed)) +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = peach[c(2, 5, 7)], guide = "none") +
  scale_slab_alpha_discrete(
    range = c(0.4, 1),
    guide = guide_legend(
      reverse = TRUE, override.aes = list(fill = "grey10"), 
      keywidth = 0.8, keyheight = 0.8, nrow = 1
    )
  ) +
  labs(
    x = "Overall average predicted probability",
    y = NULL,
    fill = NULL,
    slab_alpha = NULL,
    title = "Estimated marginal means"
  ) +
  theme(
    legend.position = "top",
    legend.justification = "left",
    legend.margin = margin(l = -7, t = 0)
  )

p_h2b_amces <- h2b_amces %>% 
  ungroup() %>% 
  separate_wider_delim(
    org_collapsed,
    delim = " - ", 
    names = c("org_collapsed", "reference_level")
  ) %>% 
  mutate(feat_govt = factor(feat_govt, levels = levels(h2a_mms$feat_govt))) %>% 
  ggplot(aes(x = avg, y = feat_govt, fill = feat_govt)) +
  stat_halfeye() +
  geom_vline(xintercept = 0, color = prism[8], linetype = "dashed", linewidth = 0.25) +
  scale_x_continuous(labels = label_pp) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = peach[c(2, 5, 7)], guide = "none") +
  facet_wrap(vars(paste(org_collapsed, "−", reference_level))) +
  labs(
    x = "Percentage point change in probability of choice selection",
    y = NULL,
    fill = NULL,
    title = "Difference in estimated marginal means",
    subtitle = "Positive values indicate greater preference for Oxfam & Red Cross"
  )

(p_h2b_mms / plot_spacer() / p_h2b_amces) +
  plot_layout(ncol = 1, heights = c(0.49, 0.02, 0.49))
```

```{r table-h2b-mm-amce}
#| column: body-outset
h2b_tbl_mm <- h2b_mms %>% 
  group_by(feat_govt, org_collapsed) %>% 
  median_qi() %>% 
  mutate(nice = glue("{fmt_decimal(avg)}<br>{build_ci(.lower, .upper)}")) %>% 
  arrange(desc(feat_govt), desc(org_collapsed)) %>% 
  select(org_collapsed, feat_govt, nice)

h2b_tbl_amces <- h2b_amces %>% 
  group_by(feat_govt, org_collapsed) %>% 
  summarize(
    median_qi(avg),
    p_gt_0 = sum(avg > 0) / n()
  ) %>%
  ungroup() %>% 
  mutate(p_neq_0 = ifelse(y >= 0, p_gt_0, 1 - p_gt_0)) %>% 
  mutate(nice = glue("{fmt_decimal(y)}<br>{build_ci(ymin, ymax)}")) %>% 
  mutate(org_collapsed = str_replace(org_collapsed, " - ", "−<br>")) %>% 
  mutate(across(starts_with("p_"), ~fmt_decimal(.))) %>% 
  arrange(desc(feat_govt)) %>% 
  select(contrast = org_collapsed, diff_nice = nice, p_neq_0)

bind_cols(
  h2b_tbl_mm, 
  h2b_tbl_amces %>% 
    add_row(contrast = NA, .after = 1) %>% 
    add_row(contrast = NA, .after = 3) %>% 
    add_row(contrast = NA, .after = 5)
) %>% 
  mutate(feat_govt = fct_relabel(feat_govt, ~paste("Relationship with government:", .x))) %>% 
  group_by(feat_govt) %>% 
  gt() %>% 
  sub_missing(columns = everything(), missing_text = "—") %>% 
  fmt_markdown(columns = c(nice, diff_nice, contrast)) %>%
  cols_align(align = "center", columns = everything()) %>% 
  cols_align(align = "left", columns = c(org_collapsed, contrast)) %>% 
  cols_label(
    org_collapsed = "Organizations", 
    nice = "Posterior EMM",
    contrast = "Contrast",
    diff_nice = "Posterior ∆",
    p_neq_0 = "*p*~direction~",
    .fn = md
  ) %>% 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>% 
  tab_style(
    style = cell_fill(color = "grey90"),
    locations = cells_row_groups()
  ) %>% 
  tab_footnote(
    footnote = "Values are on the percentage-point scale; single value is posterior median; 95% credible interval in brackets.",
    locations = cells_column_labels(columns = c(nice, diff_nice))
  ) %>% 
  tab_footnote(
    footnote = md("The probability of direction (*p*~direction~) is the probability that the posterior difference in marginal means is strictly positive or negative—it is the proportion of the posterior difference in marginal means that is the sign of the median."),
    locations = cells_column_labels(columns = p_neq_0)
  ) %>% 
  gt_add_divider(columns = nice, style = "dashed", weight = px(1)) %>% 
  opt_footnote_marks(marks = "standard") %>% 
  opt_horizontal_padding(3) %>% 
  opts_theme()
```


# H~3~: Issue Area

## H~3a~: Issue area

::: {.callout-tip}
## H~3a~: Issue area

**Donors will show increased willingness to donate to NGOs working in less contentious issue areas (emergency response and refugee relief) over more contentious issue areas (environment and human rights).**
:::

### Estimand

$$
\begin{aligned}
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Issue} = \text{More contentious} \right) \bigr] -
\textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Issue} = \text{Less contentious} \right) \bigr]
\end{aligned}
$$

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Donors appear to be sensitive to NGO issue area when they are considering to donate. Emergency response was the most favored issue area by donors, and experienced the highest likelihood of receiving donations. While this partially matches the claim of the hypothesis, donors showed the least likelihood to donate to refugee relief NGOs, which was contrary to our expectations. It is worth noting that there is some overlap between the intervals of the issue areas, which would suggest that their effect isn't as significant as other factors.
:::

```{r h3a-calc-estimands}
h3a_mms <- all_combos_means %>% 
  group_by(feat_issue, .draw) %>% 
  summarize(avg = mean(.epred))

h3a_amces <- h3a_mms %>% 
  group_by(feat_issue) %>% 
  compare_levels(variable = avg, by = feat_issue, comparison = "control")
```

```{r plot-h3a-mm-amce, fig.width=10, fig.height=4, out.width="100%"}
#| column: body-outset
p_h3a_mms <- h3a_mms %>% 
  ggplot(aes(x = avg, y = feat_issue, fill = feat_issue)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(2, 6, 8, 10)], guide = "none") +
  labs(
    x = "Overall average predicted probability",
    y = NULL,
    fill = NULL,
    title = "Estimated marginal means"
  )

p_h3a_amces <- h3a_amces %>% 
  ungroup() %>% 
  separate_wider_delim(
    feat_issue,
    delim = " - ", 
    names = c("feat_issue", "reference_level")
  ) %>% 
  add_row(avg = 0, feat_issue = "Emergency response") %>%
  mutate(feat_issue = factor(feat_issue, levels = levels(h3a_mms$feat_issue))) %>% 
  ggplot(aes(x = avg, y = feat_issue, fill = feat_issue)) +
  stat_halfeye() +
  geom_vline(xintercept = 0, color = prism[8], linetype = "dashed", linewidth = 0.25) +
  scale_x_continuous(labels = label_pp) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(2, 6, 8, 10)], guide = "none") +
  labs(
    x = "Percentage point change in probability of choice selection",
    y = NULL,
    fill = NULL,
    title = "Average marginal component effects (AMCEs)"
  )

p_h3a_mms | p_h3a_amces
```

```{r table-h3a-mm-amce}
#| column: body-outset
h3a_tbl_mm <- h3a_mms %>% 
  group_by(feat_issue) %>% 
  median_qi() %>% 
  mutate(nice = glue("{fmt_decimal(avg)}<br>{build_ci(.lower, .upper)}")) %>% 
  arrange(desc(feat_issue)) %>% 
  select(feat_issue, nice)

h3a_tbl_amces <- h3a_amces %>% 
  group_by(feat_issue) %>% 
  summarize(
    median_qi(avg),
    p_gt_0 = sum(avg > 0) / n()
  ) %>%
  mutate(p_neq_0 = ifelse(y >= 0, p_gt_0, 1 - p_gt_0)) %>% 
  mutate(nice = glue("{fmt_decimal(y)}<br>{build_ci(ymin, ymax)}")) %>% 
  mutate(feat_issue = str_replace(feat_issue, " - ", "−<br>")) %>% 
  mutate(across(starts_with("p_"), ~fmt_decimal(.))) %>% 
  arrange(desc(feat_issue)) %>% 
  select(contrast = feat_issue, amce_nice = nice, p_neq_0)

bind_cols(
  h3a_tbl_mm, 
  add_row(h3a_tbl_amces, contrast = "*(Reference)*")
) %>% 
  gt() %>% 
  sub_missing(columns = everything(), missing_text = "—") %>% 
  fmt_markdown(columns = c(nice, amce_nice, contrast)) %>%
  cols_align(align = "center", columns = everything()) %>% 
  cols_align(align = "left", columns = c(feat_issue, contrast)) %>% 
  cols_label(
    feat_issue = "Issue area", 
    nice = "Posterior EMM",
    contrast = "Contrast",
    amce_nice = "Posterior AMCE",
    p_neq_0 = "*p*~direction~",
    .fn = md
  ) %>% 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>% 
  tab_footnote(
    footnote = "Values are on the percentage-point scale; single value is posterior median; 95% credible interval in brackets.",
    locations = cells_column_labels(columns = c(nice, amce_nice))
  ) %>% 
  tab_footnote(
    footnote = md("The probability of direction (*p*~direction~) is the probability that the posterior AMCE is strictly positive or negative—it is the proportion of the posterior AMCE that is the sign of the median."),
    locations = cells_column_labels(columns = p_neq_0)
  ) %>% 
  gt_add_divider(columns = nice, style = "dashed", weight = px(1)) %>% 
  opt_footnote_marks(marks = "standard") %>% 
  opt_horizontal_padding(3) %>% 
  opts_theme()
```


## H~3b~: Relationship with host government and issue area

::: {.callout-tip}
## H~3b~: Relationship with host government and issue area

**Donors will show increased willingness to donate to NGOs facing government crackdown/criticism working in less contentious issue areas (emergency response and refugee relief) over more contentious issue areas (environment and human rights)**

*Mechanisms: Perceptions of deservingness of NGOs dealing with emergency response and refugee relief. Donors are also more likely to donate to programs that are compatible with government preferences and have easily measurable outputs, which environment and human rights programs often lack. NGOs working on more contentious issue areas may be expelled or shut down, which would be a waste of donor resources, make it less likely that they donate to these groups.*
:::

### Estimand

$$
\begin{aligned}
\theta =&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Issue} = \text{More contentious}  \mid \text{Relationship = Under crackdown or Criticized} \right) \bigr] - \\
&\ \textbf{E}\bigl[ Y_i \mid \operatorname{do}\left( \text{Issue} = \text{Less contentnious} \mid \text{Relationship = Under crackdown or Criticized} \right) \bigr]
\end{aligned}
$$

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

The generated contrasts don't provides results which are statistically significant. 0 is found within all intervals.

![](img/contrasts_hypothesis03b.png)
:::

```{r h3b-calc-estimands}
h3b_mms <- all_combos_means %>% 
  group_by(feat_issue, feat_govt, .draw) %>% 
  summarize(avg = mean(.epred))

h3b_amces <- h3b_mms %>% 
  group_by(feat_govt) %>% 
  compare_levels(variable = avg, by = feat_issue, comparison = "control")
```

```{r plot-h3b-mm-amce, fig.width=10, fig.height=6.5, out.width="100%"}
#| column: body-outset
p_h3b_mms <- h3b_mms %>% 
  ggplot(aes(x = avg, y = feat_issue, fill = feat_issue)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(2, 6, 8, 10)], guide = "none") +
  facet_wrap(vars(feat_govt), ncol = 1) +
  labs(
    x = "Overall average predicted probability",
    y = NULL,
    fill = NULL,
    title = "Estimated marginal means"
  ) +
  theme(
    legend.position = "top",
    legend.justification = "left",
    legend.margin = margin(l = -7, t = 0)
  )

p_h3b_amces <- h3b_amces %>% 
  ungroup() %>% 
  separate_wider_delim(
    feat_issue,
    delim = " - ", 
    names = c("feat_issue", "reference_level")
  ) %>% 
  add_row(avg = 0, feat_issue = "Emergency response", feat_govt = "Friendly") %>%
  add_row(avg = 0, feat_issue = "Emergency response", feat_govt = "Criticized") %>%
  add_row(avg = 0, feat_issue = "Emergency response", feat_govt = "Under crackdown") %>%
  mutate(feat_issue = factor(feat_issue, levels = levels(h3b_mms$feat_issue))) %>% 
  ggplot(aes(x = avg, y = feat_issue, fill = feat_issue)) +
  stat_halfeye() +
  geom_vline(xintercept = 0, color = prism[8], linetype = "dashed", linewidth = 0.25) +
  scale_x_continuous(labels = label_pp) +
  scale_y_discrete(labels = label_wrap(10)) +
  scale_fill_manual(values = prism[c(2, 6, 8, 10)], guide = "none") +
  facet_wrap(vars(feat_govt), ncol = 1) +
  labs(
    x = "Percentage point change in probability of choice selection",
    y = NULL,
    fill = NULL,
    title = "Difference in estimated marginal means"
  )

p_h3b_mms | p_h3b_amces
```

```{r table-h3b-mm-amce}
#| column: body-outset
h3b_tbl_mm <- h3b_mms %>% 
  group_by(feat_govt, feat_issue) %>% 
  median_qi() %>% 
  mutate(nice = glue("{fmt_decimal(avg)}<br>{build_ci(.lower, .upper)}")) %>% 
  arrange(desc(feat_govt), desc(feat_issue)) %>% 
  select(feat_issue, feat_govt, nice)

h3b_tbl_amces <- h3b_amces %>% 
  group_by(feat_govt, feat_issue) %>% 
  summarize(
    median_qi(avg),
    p_gt_0 = sum(avg > 0) / n()
  ) %>%
  ungroup() %>% 
  mutate(p_neq_0 = ifelse(y >= 0, p_gt_0, 1 - p_gt_0)) %>% 
  mutate(nice = glue("{fmt_decimal(y)}<br>{build_ci(ymin, ymax)}")) %>% 
  mutate(feat_issue = str_replace(feat_issue, " - ", "−<br>")) %>% 
  mutate(across(starts_with("p_"), ~fmt_decimal(.))) %>% 
  arrange(desc(feat_govt)) %>% 
  select(contrast = feat_issue, diff_nice = nice, p_neq_0)

bind_cols(
  h3b_tbl_mm, 
  h3b_tbl_amces %>% 
    add_row(contrast = NA, .after = 3) %>% 
    add_row(contrast = NA, .after = 7) %>% 
    add_row(contrast = NA, .after = 12)
) %>% 
  mutate(feat_govt = fct_relabel(feat_govt, ~paste("Relationship with government:", .x))) %>% 
  group_by(feat_govt) %>% 
  gt() %>% 
  sub_missing(columns = everything(), missing_text = "—") %>% 
  fmt_markdown(columns = c(nice, diff_nice, contrast)) %>%
  cols_align(align = "center", columns = everything()) %>% 
  cols_align(align = "left", columns = c(feat_issue, contrast)) %>% 
  cols_label(
    feat_issue = "Issue", 
    nice = "Posterior EMM",
    contrast = "Contrast",
    diff_nice = "Posterior ∆",
    p_neq_0 = "*p*~direction~",
    .fn = md
  ) %>% 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>% 
  tab_style(
    style = cell_fill(color = "grey90"),
    locations = cells_row_groups()
  ) %>% 
  tab_footnote(
    footnote = "Values are on the percentage-point scale; single value is posterior median; 95% credible interval in brackets.",
    locations = cells_column_labels(columns = c(nice, diff_nice))
  ) %>% 
  tab_footnote(
    footnote = md("The probability of direction (*p*~direction~) is the probability that the posterior difference in marginal means is strictly positive or negative—it is the proportion of the posterior difference in marginal means that is the sign of the median."),
    locations = cells_column_labels(columns = p_neq_0)
  ) %>% 
  gt_add_divider(columns = nice, style = "dashed", weight = px(1)) %>% 
  opt_footnote_marks(marks = "standard") %>% 
  opt_horizontal_padding(3) %>% 
  opts_theme()
```


# H~4~: Funding sources

## H~4a~: Funding sources

> Donors will show increased willingness to donate to NGOs that are funded primarily by numerous small private donors compared to NGOs that are funded by a handful of wealthy private donors and government grants [Mechanism: Perception of efficacy - your contribution matters as a small donor. Government funding may also imply lack of independence of government which can reduce the efficiency of an organization.]

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

As stated in the hypothesis, donors show increased willingness to donate to NGOs funded by numerous small private donors, as opposed to those funded by a handful of wealthy private donors or government grants.

![](img/contrasts_hypothesis04.png)
:::

## H~4b~: Relationship with host government and funding sources

> Donors will show increased willingness to donate to NGOs that are facing government crackdown and are funded primarily by numerous small private donors

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

The marginal posteriors for these contrasts are strange, but still tell us that the interaction between funding sources and government relationship produce no significant effects.

![](img/contrasts_hypothesis04b.png)
:::

## H~4c~: Relationship with host government, funding sources, and issue area

> Donors will show increased willingness to donate to NGOs that are facing government crackdown and are funded primarily by numerous small private donors and work in less contentious areas (emergency response and refugee relief) 

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Once again, we see some interesting distributions, but no results significant enough to confirm our hypothesis.

![](img/contrasts_hypothesis04c.png)
:::

# H~5~: Organizational practices

## H~5a~: Organizational practices

> Donors will show increased willingness to donate to NGOs that are financially transparent [Mechanism: Perception of efficacy]

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Donors show an increased likelihood to donate to NGOs that are financially transparent, as hypothesized.

![](img/contrasts_hypothesis05.png)
:::

## H~5b~: Relationship with host government, organizational practices

> Donors will show increased willingness to donate to NGOs that are criticized by the government/under government crackdown when they are also financially transparent

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Donors show a similar increase in willingness to donate to accountable NGOs in comparison to NGOs that are financially transparent. However, this is contrary to what was hypothesized--we predicted that donor's willingness to donate wouldn't be affected by accountability practices.

![](img/contrasts_hypothesis05b.png)
:::

## H~5c~: Relationship with host government, organizational practices, and funding sources

> Donors will show increased willingness to donate to NGOs that are criticized by the government/under government crackdown when they are also financially transparent and are funded primarily by numerous small private donors

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

These intervals are massive; 0 is well within them, leaving us with insufficient evidence to confirm the hypothesis.

![](img/contrasts_hypothesis05c.png)
:::

## H~5d~: Relationship with host government, organizational practices, and issue area

> Donors will show increased willingness to donate to NGOs that are criticized by the government/under government crackdown when they are also financially transparent and work in less contentious areas (emergency response and refugee relief) 

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

The contrasts don't support the hypothesis, however, there is an interesting difference between emergency_environment_crackdown and emergency_environment_criticized.

![](img/contrasts_hypothesis05d.png)
:::

## H~5e~: Relationship with host government, organizational practices, issue area, and funding sources

> Donors will show increased willingness to donate to NGOs that are criticized by the government/under government crackdown when they are also financially transparent and work in less contentious areas (emergency response and refugee relief) and are funded by numerous small donors

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

These marginal posteriors don't support our hypothesis, but again show an interesting difference between emergency_environment_criticized and emergency_environment_crackdown.

![](img/contrasts_hypothesis05e.png)
:::

## H~5f~: Organizational practices

> Donors should be no more or less likely to donate to NGOs that are accountable and hold regular third party audits [Mechanism: Donors don't necessarily seek assurance through third-party programs/audits and charity watchdogs, but rather through word of mouth, personal scrutiny and local networks]

::: {.callout-note collapse="true"}
## Show results from `contrasts` branch

Donors show a similar increase in willingness to donate to accountable NGOs in comparison to NGOs that are financially transparent. However, this is contrary to what was hypothesized--we predicted that donor's willingness to donate wouldn't be affected by accountability practices.

![](img/contrasts_hypothesis05f.png)
:::
