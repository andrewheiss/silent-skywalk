---
title: "Methods"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center", fig.retina = 3,
  fig.width = 6, fig.height = (6 * 0.618),
  out.width = "80%", collapse = TRUE,
  dev = "ragg_png"
)

options(
  digits = 3, width = 120,
  dplyr.summarise.inform = FALSE,
  knitr.kable.NA = ""
)
```

```{r libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(targets)
library(gt)
library(gtExtras)

tar_config_set(
  store = here::here("_targets"),
  script = here::here("_targets.R")
)

preds_all <- tar_read(preds_conditional_treatment_only)

invisible(list2env(tar_read(graphic_functions), .GlobalEnv))
invisible(list2env(tar_read(table_functions), .GlobalEnv))

theme_set(theme_ngo())
```

# Model

TODO: Intercept only because (1) LOO is best, and (2) it makes most sense causally since all confounding arrows are deleted due to randomization


# Method: Marginal means

To find the causal effects defined in each of our estimands, we calculate estimated marginal means (EMMs) by finding the fitted values for each cell in a balanced reference grid of all 576 possible combinations of feature levels (4 organizations × 4 issues × 2 transparency × 2 accountability × 3 funding × 3 government relationship = 576 rows). We transform these estimates to the probability scale in order to work directly with predicted probabilities rather than the link (logit) scale. We then calculate group averages and contrasts in group averages for each of the features of interest, marginalizing over all other features.

TODO: Simple example here to just to illustrate the process—show literal marginal means in the margins of a balanced reference grid, then subtract them for the difference in marginal means, or AMCEs

Here's what the full grid of 576 options looks like, with posterior median predictions for each combination:

```{r}
#| column: screen-inset
preds_all %>% 
  group_by(feat_org, feat_issue, feat_transp, feat_acc, feat_funding, feat_govt) %>% 
  summarize(avg = mean(.epred)) %>% 
  ungroup() %>% 
  gt() %>% 
  cols_align(align = "left") %>% 
  cols_label(
    feat_org = "Organization",
    feat_issue = "Issue",
    feat_transp = "Transparency",
    feat_acc = "Accountability",
    feat_funding = "Funding",
    feat_govt = "Relationship",
    avg = "Median probability"
  ) %>% 
  opts_theme() %>% 
  opt_interactive(use_compact_mode = TRUE, use_highlight = TRUE, use_filters = TRUE)
```
